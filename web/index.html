<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS逆向沙箱化补环境框架</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/lib/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/theme/monokai.min.css">
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>JS沙箱框架</span>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="sandbox">
                    <i class="fas fa-terminal"></i>
                    <span>沙箱执行</span>
                </a>
                <a href="#" class="nav-item" data-page="env">
                    <i class="fas fa-folder-tree"></i>
                    <span>环境管理</span>
                </a>
                <a href="#" class="nav-item" data-page="undefined">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>undefined监控</span>
                    <span class="badge" id="undefined-count">0</span>
                </a>
                <a href="#" class="nav-item" data-page="ai">
                    <i class="fas fa-robot"></i>
                    <span>AI补环境</span>
                </a>
                <a href="#" class="nav-item" data-page="snapshot">
                    <i class="fas fa-camera"></i>
                    <span>快照管理</span>
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <i class="fas fa-list-alt"></i>
                    <span>日志查看</span>
                </a>
                <a href="#" class="nav-item" data-page="mock">
                    <i class="fas fa-cogs"></i>
                    <span>Mock配置</span>
                </a>
                <a href="#" class="nav-item" data-page="monitor">
                    <i class="fas fa-chart-line"></i>
                    <span>监控面板</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="status-indicator">
                    <span class="dot"></span>
                    <span id="sandbox-status">沙箱就绪</span>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 沙箱执行页面 -->
            <section id="page-sandbox" class="page active">
                <header class="page-header">
                    <h1><i class="fas fa-terminal"></i> 沙箱执行面板</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="resetSandbox()">
                            <i class="fas fa-redo"></i> 重置沙箱
                        </button>
                    </div>
                </header>
                <div class="page-content">
                    <div class="code-panel">
                        <div class="panel-header">
                            <span>输入JS代码</span>
                            <div class="panel-actions">
                                <button class="btn btn-sm" onclick="formatCode()">
                                    <i class="fas fa-magic"></i> 格式化
                                </button>
                                <button class="btn btn-sm" onclick="clearCode()">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                        </div>
                        <textarea id="code-input"></textarea>
                        <div class="code-actions">
                            <button class="btn btn-primary btn-lg" onclick="executeCode()">
                                <i class="fas fa-play"></i> 执行代码
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto-reset" checked>
                                执行前重置
                            </label>
                        </div>
                    </div>
                    <div class="result-panel">
                        <div class="panel-header">
                            <span>执行结果</span>
                            <span class="execution-time" id="exec-time"></span>
                        </div>
                        <div class="result-tabs">
                            <button class="tab-btn active" data-tab="result">结果</button>
                            <button class="tab-btn" data-tab="undefined">Undefined</button>
                            <button class="tab-btn" data-tab="console">Console</button>
                        </div>
                        <div class="tab-content active" id="tab-result">
                            <pre id="exec-result"></pre>
                        </div>
                        <div class="tab-content" id="tab-undefined">
                            <div id="undefined-list"></div>
                        </div>
                        <div class="tab-content" id="tab-console">
                            <pre id="console-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 环境管理页面 -->
            <section id="page-env" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-folder-tree"></i> 环境文件管理</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshEnvTree()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                    </div>
                </header>
                <div class="page-content env-layout">
                    <div class="file-tree-panel">
                        <div class="panel-header">目录结构</div>
                        <div id="env-tree" class="file-tree"></div>
                    </div>
                    <div class="file-editor-panel">
                        <div class="panel-header">
                            <span id="current-file-path">选择文件进行编辑</span>
                            <div class="panel-actions">
                                <button class="btn btn-sm btn-primary" onclick="saveEnvFile()" id="save-btn" disabled>
                                    <i class="fas fa-save"></i> 保存
                                </button>
                            </div>
                        </div>
                        <textarea id="env-editor"></textarea>
                    </div>
                </div>
            </section>

            <!-- Undefined监控页面 -->
            <section id="page-undefined" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-exclamation-triangle"></i> Undefined属性监控</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshUndefinedList()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                        <button class="btn btn-primary" onclick="autoCompleteAll()">
                            <i class="fas fa-magic"></i> 一键AI补充
                        </button>
                    </div>
                </header>
                <div class="page-content">
                    <div class="undefined-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-undefined"></th>
                                    <th>属性路径</th>
                                    <th>上下文</th>
                                    <th>时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="undefined-table-body">
                            </tbody>
                        </table>
                        <div class="empty-state" id="no-undefined">
                            <i class="fas fa-check-circle"></i>
                            <p>暂无未定义属性</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI补环境页面 -->
            <section id="page-ai" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-robot"></i> AI辅助补环境</h1>
                </header>
                <div class="page-content ai-layout">
                    <div class="ai-config-panel">
                        <h3>AI配置</h3>
                        <div class="form-group">
                            <label>AI平台</label>
                            <select id="ai-platform">
                                <option value="openai">OpenAI</option>
                                <option value="deepseek">DeepSeek</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="ai-api-key" placeholder="输入API Key">
                        </div>
                        <div class="form-group">
                            <label>Base URL (可选)</label>
                            <input type="text" id="ai-base-url" placeholder="自定义API地址">
                        </div>
                        <button class="btn btn-primary" onclick="saveAIConfig()">
                            <i class="fas fa-save"></i> 保存配置
                        </button>
                    </div>
                    <div class="ai-generate-panel">
                        <h3>生成补环境代码</h3>
                        <div class="form-group">
                            <label>属性/方法名</label>
                            <input type="text" id="ai-property" placeholder="如: navigator.webdriver">
                        </div>
                        <div class="form-group">
                            <label>所属对象</label>
                            <input type="text" id="ai-object" value="window" placeholder="如: window">
                        </div>
                        <div class="form-group">
                            <label>上下文描述 (可选)</label>
                            <textarea id="ai-context" placeholder="描述调用场景..."></textarea>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="generateEnvCode()">
                            <i class="fas fa-wand-magic-sparkles"></i> 生成代码
                        </button>
                    </div>
                    <div class="ai-result-panel">
                        <h3>生成结果</h3>
                        <div class="ai-result-header">
                            <span id="ai-result-info"></span>
                            <div class="panel-actions">
                                <button class="btn btn-sm" onclick="copyGeneratedCode()" id="copy-ai-btn" disabled>
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="applyGeneratedCode()" id="apply-ai-btn" disabled>
                                    <i class="fas fa-check"></i> 应用
                                </button>
                            </div>
                        </div>
                        <textarea id="ai-result-code" readonly></textarea>
                    </div>
                    <div class="ai-history-panel">
                        <h3>生成历史</h3>
                        <div id="ai-history-list" class="history-list"></div>
                    </div>
                </div>
            </section>

            <!-- 快照管理页面 -->
            <section id="page-snapshot" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-camera"></i> 快照管理</h1>
                </header>
                <div class="page-content">
                    <div class="snapshot-create">
                        <h3>创建快照</h3>
                        <div class="input-group">
                            <input type="text" id="snapshot-name" placeholder="输入快照名称">
                            <button class="btn btn-primary" onclick="createSnapshot()">
                                <i class="fas fa-camera"></i> 保存快照
                            </button>
                        </div>
                    </div>
                    <div class="snapshot-list-container">
                        <h3>已保存快照</h3>
                        <div id="snapshot-list" class="snapshot-grid"></div>
                        <div class="empty-state" id="no-snapshots">
                            <i class="fas fa-camera-retro"></i>
                            <p>暂无保存的快照</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 日志查看页面 -->
            <section id="page-logs" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-list-alt"></i> 日志查看</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            <i class="fas fa-download"></i> 导出
                        </button>
                        <button class="btn btn-danger" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                    </div>
                </header>
                <div class="page-content">
                    <div class="log-tabs">
                        <button class="tab-btn active" data-log-tab="access">访问日志</button>
                        <button class="tab-btn" data-log-tab="undefined">Undefined</button>
                        <button class="tab-btn" data-log-tab="calls">方法调用</button>
                        <button class="tab-btn" data-log-tab="create">元素创建</button>
                        <button class="tab-btn" data-log-tab="ai">AI历史</button>
                    </div>
                    <div class="log-content active" id="log-access">
                        <div id="access-log-list" class="log-list"></div>
                    </div>
                    <div class="log-content" id="log-undefined">
                        <div id="undefined-log-list" class="log-list"></div>
                    </div>
                    <div class="log-content" id="log-calls">
                        <div id="calls-log-list" class="log-list"></div>
                    </div>
                    <div class="log-content" id="log-create">
                        <div id="create-log-list" class="log-list"></div>
                    </div>
                    <div class="log-content" id="log-ai">
                        <div id="ai-log-list" class="log-list"></div>
                    </div>
                </div>
            </section>

            <!-- Mock配置页面 -->
            <section id="page-mock" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-cogs"></i> Mock返回值配置</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshMockList()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                        <button class="btn btn-primary" onclick="showAddMockModal()">
                            <i class="fas fa-plus"></i> 添加Mock
                        </button>
                    </div>
                </header>
                <div class="page-content">
                    <div class="mock-info">
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            <p>Mock配置允许你自定义方法的返回值，用于模拟特定的浏览器行为。例如：</p>
                            <ul>
                                <li><code>document.getElementById</code> - 返回自定义元素或null</li>
                                <li><code>canvas.getContext</code> - 返回mock的canvas上下文</li>
                                <li><code>window.confirm</code> - 控制确认对话框的返回值</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mock-preset-section">
                        <h3><i class="fas fa-magic"></i> 预设Mock模板</h3>
                        <div class="preset-grid">
                            <button class="preset-btn" onclick="applyPresetMock('anti-detect')">
                                <i class="fas fa-user-secret"></i>
                                <span>反检测模式</span>
                                <small>隐藏自动化特征</small>
                            </button>
                            <button class="preset-btn" onclick="applyPresetMock('canvas-fp')">
                                <i class="fas fa-fingerprint"></i>
                                <span>Canvas指纹</span>
                                <small>固定Canvas返回值</small>
                            </button>
                            <button class="preset-btn" onclick="applyPresetMock('webgl-fp')">
                                <i class="fas fa-cube"></i>
                                <span>WebGL指纹</span>
                                <small>模拟WebGL参数</small>
                            </button>
                            <button class="preset-btn" onclick="applyPresetMock('audio-fp')">
                                <i class="fas fa-volume-up"></i>
                                <span>Audio指纹</span>
                                <small>固定Audio上下文</small>
                            </button>
                        </div>
                    </div>
                    <div class="mock-list-section">
                        <h3><i class="fas fa-list"></i> 当前Mock配置</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>路径</th>
                                    <th>返回类型</th>
                                    <th>返回值预览</th>
                                    <th>调用次数</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="mock-table-body">
                            </tbody>
                        </table>
                        <div class="empty-state" id="no-mocks">
                            <i class="fas fa-cog"></i>
                            <p>暂无Mock配置</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 监控面板页面 -->
            <section id="page-monitor" class="page">
                <header class="page-header">
                    <h1><i class="fas fa-chart-line"></i> 实时监控面板</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshMonitorStats()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-refresh-monitor" checked>
                            自动刷新 (3s)
                        </label>
                    </div>
                </header>
                <div class="page-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-eye"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-access">0</span>
                                <span class="stat-label">属性访问</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-phone"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-calls">0</span>
                                <span class="stat-label">方法调用</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-plus-circle"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-create">0</span>
                                <span class="stat-label">元素创建</span>
                            </div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-undefined">0</span>
                                <span class="stat-label">未定义属性</span>
                            </div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-fixed">0</span>
                                <span class="stat-label">已修复</span>
                            </div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-icon"><i class="fas fa-cogs"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="stat-mocks">0</span>
                                <span class="stat-label">活跃Mock</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="monitor-panels">
                        <div class="monitor-panel">
                            <h3><i class="fas fa-fire"></i> 热点方法调用 (Top 10)</h3>
                            <div id="hot-methods-list" class="hot-list"></div>
                        </div>
                        <div class="monitor-panel">
                            <h3><i class="fas fa-tags"></i> 创建的元素类型</h3>
                            <div id="element-types-list" class="element-type-list"></div>
                        </div>
                    </div>

                    <div class="call-chain-panel">
                        <h3><i class="fas fa-stream"></i> 最近调用链</h3>
                        <div id="call-chain-list" class="call-chain-list"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 模态框 -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <!-- Toast通知 -->
    <div id="toast-container"></div>

    <!-- 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
